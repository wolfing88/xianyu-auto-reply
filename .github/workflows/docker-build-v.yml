name: ğŸ³ Build and Push Multi-Arch Docker Image

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      tag:
        description: 'é•œåƒç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.5)'
        required: true
        default: '1.0.5'
  
  # è‡ªåŠ¨è§¦å‘
  push:
    # å½“åˆ›å»ºtagæ—¶è§¦å‘
    tags:
      - 'v*'
    # å½“Dockerfileæˆ–ç›¸å…³æ–‡ä»¶è¢«ä¿®æ”¹æ—¶è§¦å‘ï¼ˆå¯é€‰ï¼‰
    branches:
      - main
      - master
    paths:
      - 'Dockerfile'
      - 'Dockerfile-cn'
      - 'requirements.txt'
      - '.github/workflows/docker-build-v.yml'

jobs:
  build-and-push:
    name: ğŸ—ï¸ Build Multi-Arch Docker Images
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          
          # å›½å†…ç‰ˆ (é˜¿é‡Œäº‘)
          - dockerfile: Dockerfile
            registry: crpi-is3qqm9horb48xeu.cn-guangzhou.personal.cr.aliyuncs.com
            image_name: vito-software/xianyu-auto-reply
            tag_suffix: ''
    
    steps:
    - name: ğŸ“¥ Checkoutä»£ç 
      uses: actions/checkout@v4
    
    - name: ğŸ”§ è®¾ç½®QEMU (ARMæ¨¡æ‹Ÿ)
      uses: docker/setup-qemu-action@v3
      with:
        platforms: linux/amd64,linux/arm64
    
    - name: ğŸ”§ è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        install: true
        platforms: linux/amd64,linux/arm64
    
    
    - name: ğŸ” ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“
      if: matrix.registry == 'crpi-is3qqm9horb48xeu.cn-guangzhou.personal.cr.aliyuncs.com'
      uses: docker/login-action@v3
      with:
        registry: crpi-is3qqm9horb48xeu.cn-guangzhou.personal.cr.aliyuncs.com
        username: ${{ secrets.ALIYUN_USERNAME }}
        password: ${{ secrets.ALIYUN_TOKEN }}
    
    - name: ğŸ“ æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ matrix.registry }}/${{ matrix.image_name }}
        tags: |
          # ä»tagæå–ç‰ˆæœ¬å·: v1.0.5 -> 1.0.5
          type=semver,pattern={{version}}
          # ä»æ‰‹åŠ¨è¾“å…¥æå–
          type=raw,value=${{ github.event.inputs.tag }},enable=${{ github.event_name == 'workflow_dispatch' }}
          # latestæ ‡ç­¾
          type=raw,value=latest
    
    - name: ğŸ—ï¸ æ„å»ºå¹¶æ¨é€å¤šæ¶æ„é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ matrix.dockerfile }}
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILDTIME=${{ github.event.head_commit.timestamp }}
          VERSION=${{ steps.meta.outputs.version }}
    
    - name: ğŸ“Š è¾“å‡ºé•œåƒä¿¡æ¯
      run: |
        echo "========================================="
        echo "âœ… é•œåƒæ„å»ºæˆåŠŸï¼"
        echo "========================================="
        echo "é•œåƒä»“åº“: ${{ matrix.registry }}"
        echo "é•œåƒåç§°: ${{ matrix.image_name }}"
        echo "æ”¯æŒæ¶æ„: linux/amd64, linux/arm64"
        echo ""
        echo "ğŸ“¦ é•œåƒæ ‡ç­¾:"
        echo "${{ steps.meta.outputs.tags }}"
        echo ""
        echo "ğŸš€ ä½¿ç”¨æ–¹æ³•:"
        echo "docker pull ${{ matrix.registry }}/${{ matrix.image_name }}:latest"
        echo "========================================="
